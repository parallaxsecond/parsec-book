<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Adding a new Parsec Provider - The Parsec Book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">2.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../getting_started/index.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting_started/linux_x86.html"><strong aria-hidden="true">3.1.</strong> Quickstart for Linux on x86</a></li><li class="chapter-item expanded "><a href="../getting_started/opensuse.html"><strong aria-hidden="true">3.2.</strong> Quickstart for openSUSE and SUSE</a></li><li class="chapter-item expanded "><a href="../getting_started/docker.html"><strong aria-hidden="true">3.3.</strong> Quickstart using a Docker container</a></li></ol></li><li class="chapter-item expanded "><a href="../parsec_users.html"><strong aria-hidden="true">4.</strong> Parsec for users</a></li><li class="chapter-item expanded "><a href="../parsec_client/index.html"><strong aria-hidden="true">5.</strong> Parsec for client developers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_client/api_overview.html"><strong aria-hidden="true">5.1.</strong> API Overview</a></li><li class="chapter-item expanded "><a href="../parsec_client/wire_protocol.html"><strong aria-hidden="true">5.2.</strong> Wire Protocol</a></li><li class="chapter-item expanded "><a href="../parsec_client/status_codes.html"><strong aria-hidden="true">5.3.</strong> Status Codes</a></li><li class="chapter-item expanded "><a href="../parsec_client/writing_library.html"><strong aria-hidden="true">5.4.</strong> Writing a new Parsec Client Library</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/index.html"><strong aria-hidden="true">5.5.</strong> Operations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_client/operations/service_api_coverage.html"><strong aria-hidden="true">5.5.1.</strong> Parsec Operations Coverage</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_key_attributes.html"><strong aria-hidden="true">5.5.2.</strong> PSA Key Attributes</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_algorithm.html"><strong aria-hidden="true">5.5.3.</strong> PSA Algorithm</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/ping.html"><strong aria-hidden="true">5.5.4.</strong> Ping</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_generate_key.html"><strong aria-hidden="true">5.5.5.</strong> PsaGenerateKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_destroy_key.html"><strong aria-hidden="true">5.5.6.</strong> PsaDestroyKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_sign_hash.html"><strong aria-hidden="true">5.5.7.</strong> PsaSignHash</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_verify_hash.html"><strong aria-hidden="true">5.5.8.</strong> PsaVerifyHash</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_import_key.html"><strong aria-hidden="true">5.5.9.</strong> PsaImportKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_export_public_key.html"><strong aria-hidden="true">5.5.10.</strong> PsaExportPublicKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_providers.html"><strong aria-hidden="true">5.5.11.</strong> ListProviders</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_opcodes.html"><strong aria-hidden="true">5.5.12.</strong> ListOpcodes</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_asymmetric_encrypt.html"><strong aria-hidden="true">5.5.13.</strong> PsaAsymmetricEncrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_asymmetric_decrypt.html"><strong aria-hidden="true">5.5.14.</strong> PsaAsymmetricDecrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_export_key.html"><strong aria-hidden="true">5.5.15.</strong> PsaExportKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_generate_random.html"><strong aria-hidden="true">5.5.16.</strong> PsaGenerateRandom</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_authenticators.html"><strong aria-hidden="true">5.5.17.</strong> ListAuthenticators</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_hash_compute.html"><strong aria-hidden="true">5.5.18.</strong> PsaHashCompute</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_hash_compare.html"><strong aria-hidden="true">5.5.19.</strong> PsaHashCompare</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_aead_encrypt.html"><strong aria-hidden="true">5.5.20.</strong> PsaAeadEncrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_aead_decrypt.html"><strong aria-hidden="true">5.5.21.</strong> PsaAeadDecrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_raw_key_agreement.html"><strong aria-hidden="true">5.5.22.</strong> PsaRawKeyAgreement</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_cipher_encrypt.html"><strong aria-hidden="true">5.5.23.</strong> PsaCipherEncrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_cipher_decrypt.html"><strong aria-hidden="true">5.5.24.</strong> PsaCipherDecrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_mac_compute.html"><strong aria-hidden="true">5.5.25.</strong> PsaMacCompute</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_mac_verify.html"><strong aria-hidden="true">5.5.26.</strong> PsaMacVerify</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_sign_message.html"><strong aria-hidden="true">5.5.27.</strong> PsaSignMessage</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_verify_message.html"><strong aria-hidden="true">5.5.28.</strong> PsaVerifyMessage</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_keys.html"><strong aria-hidden="true">5.5.29.</strong> ListKeys</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_clients.html"><strong aria-hidden="true">5.5.30.</strong> ListClients</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/delete_client.html"><strong aria-hidden="true">5.5.31.</strong> DeleteClient</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/prepare_key_attestation_params.html"><strong aria-hidden="true">5.5.32.</strong> Prepare Key Attestation Parameters</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/prepare_key_attestation.html"><strong aria-hidden="true">5.5.33.</strong> PrepareKeyAttestation</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/attest_key.html"><strong aria-hidden="true">5.5.34.</strong> AttestKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/attest_key_params.html"><strong aria-hidden="true">5.5.35.</strong> Attest Key Parameters</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/can_do_crypto.html"><strong aria-hidden="true">5.5.36.</strong> CanDoCrypto</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../parsec_service/index.html"><strong aria-hidden="true">6.</strong> Parsec for service developers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_service/interfaces_and_dataflow.html"><strong aria-hidden="true">6.1.</strong> Interfaces and Dataflow</a></li><li class="chapter-item expanded "><a href="../parsec_service/source_code_structure.html"><strong aria-hidden="true">6.2.</strong> Source Code Structure</a></li><li class="chapter-item expanded "><a href="../parsec_service/listeners.html"><strong aria-hidden="true">6.3.</strong> Listeners</a></li><li class="chapter-item expanded "><a href="../parsec_service/authenticators.html"><strong aria-hidden="true">6.4.</strong> Authenticators</a></li><li class="chapter-item expanded "><a href="../parsec_service/converters.html"><strong aria-hidden="true">6.5.</strong> Converters</a></li><li class="chapter-item expanded "><a href="../parsec_service/providers.html"><strong aria-hidden="true">6.6.</strong> Providers</a></li><li class="chapter-item expanded "><a href="../parsec_service/key_info_managers.html"><strong aria-hidden="true">6.7.</strong> Key Info Managers</a></li><li class="chapter-item expanded "><a href="../parsec_service/adding_provider.html" class="active"><strong aria-hidden="true">6.8.</strong> Adding a new Parsec Provider</a></li><li class="chapter-item expanded "><a href="../parsec_service/build_run.html"><strong aria-hidden="true">6.9.</strong> How to build and run Parsec</a></li><li class="chapter-item expanded "><a href="../parsec_service/install_parsec_linux.html"><strong aria-hidden="true">6.10.</strong> How to securely install Parsec on Linux</a></li><li class="chapter-item expanded "><a href="../parsec_service/configuration.html"><strong aria-hidden="true">6.11.</strong> Parsec Configuration</a></li><li class="chapter-item expanded "><a href="../parsec_service/tests/index.html"><strong aria-hidden="true">6.12.</strong> How to test Parsec</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_service/tests/existing_tests.html"><strong aria-hidden="true">6.12.1.</strong> List of existing tests</a></li></ol></li><li class="chapter-item expanded "><a href="../parsec_service/stability.html"><strong aria-hidden="true">6.13.</strong> Parsec Stability</a></li></ol></li><li class="chapter-item expanded "><a href="../parsec_security/index.html"><strong aria-hidden="true">7.</strong> Parsec Security</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_security/parsec_threat_model/threat_model.html"><strong aria-hidden="true">7.1.</strong> Parsec Threat Model</a></li><li class="chapter-item expanded "><a href="../parsec_security/secure_deployment.html"><strong aria-hidden="true">7.2.</strong> Recommendations for Secure Deployment</a></li><li class="chapter-item expanded "><a href="../parsec_security/rust_client_threat_model/threat_model.html"><strong aria-hidden="true">7.3.</strong> Parsec Rust Client Threat Model</a></li></ol></li><li class="chapter-item expanded "><a href="../contributing/index.html"><strong aria-hidden="true">8.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contributing/pr_checklist.html"><strong aria-hidden="true">8.1.</strong> Pull request checklist</a></li><li class="chapter-item expanded "><a href="../contributing/adding_new_operation_how_to.html"><strong aria-hidden="true">8.2.</strong> How to add operations to Parsec</a></li><li class="chapter-item expanded "><a href="../contributing/package_management.html"><strong aria-hidden="true">8.3.</strong> Package management and versioning guide</a></li><li class="chapter-item expanded "><a href="../contributing/release_process.html"><strong aria-hidden="true">8.4.</strong> The Parsec Release Process</a></li></ol></li><li class="chapter-item expanded "><a href="../archive/index.html"><strong aria-hidden="true">9.</strong> Archive</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../archive/system_architecture.html"><strong aria-hidden="true">9.1.</strong> System Architecture</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Parsec Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="adding-a-new-parsec-provider"><a class="header" href="#adding-a-new-parsec-provider">Adding a new Parsec Provider</a></h1>
<p>Creating new providers means enabling Parsec to work on new platforms and is one of the main goals
of the project. As such, the interface that must be implemented by each provider was built with
modularity in mind, allowing developers to choose which operations they implement and when. This
interface is represented by a Rust <a href="https://doc.rust-lang.org/book/ch10-02-traits.html"><code>trait</code></a> -
more precisely, the
<a href="https://docs.rs/parsec-service/latest/parsec_service/providers/trait.Provide.html"><code>Provide</code></a>
trait.</p>
<p>The full list of operations that can be implemented can be found in the link above and will be
expanded as the project progresses towards supporting more use cases.</p>
<h2 id="mandatory-methods"><a class="header" href="#mandatory-methods">Mandatory methods</a></h2>
<p>Some <code>Provide</code> trait methods are mandatory for the service to behave normally. They are used on a
service-level by the core provider and so must be supported by all providers.</p>
<ul>
<li><code>describe</code>: Each provider must offer a description of itself in the shape of a
<a href="https://docs.rs/parsec-interface/latest/parsec_interface/operations/list_providers/struct.ProviderInfo.html"><code>ProviderInfo</code></a>
value, by implementing the <code>describe</code> method. The UUID identifying the provider is
developer-generated and should not clash with existing providers. This process also requires the
new provider to be added to the
<a href="https://docs.rs/parsec-interface/0.25.0/parsec_interface/requests/enum.ProviderId.html"><code>ProviderID</code></a>
enum. The <code>describe</code> method is also used to return the supported opcodes by the provider.</li>
<li><code>list_keys</code>: the provider must implement this method to return all the keys stored within the
provider for a particular application name.</li>
<li><code>list_clients</code>: the provider must implement this method to return the application names that have
data stored within the provider.</li>
</ul>
<p><code>list_keys</code> and <code>list_clients</code> can often be implemented by directly using the
<code>KeyInfoManagerClient</code>.</p>
<h2 id="data-format"><a class="header" href="#data-format">Data format</a></h2>
<p>Lots of care must be taken when implementing operations that the inputs and outputs are in the
correct format, especially in the case of byte arrays. Detailed description of all input and output
can be found in the <a href="../parsec_client/operations">operations documentation</a>.</p>
<h2 id="key-management"><a class="header" href="#key-management">Key management</a></h2>
<p>A helpful utility that the Parsec service offers to providers is the use of key info managers. These
allow the provider to persist mappings between key names and key information material and is
generally needed since providers are expected to support UTF-8 encoded strings as key names. To use
the KeyInfoManager in a thread-safe and convenient way, the KeyInfoManagerClient structure can be
used. The key ID type used will have to implement <code>serde</code> <code>Serialize</code> and <code>DeserializedOwned</code>
traits.</p>
<h3 id="dealing-with-key-triple-mappings-coherency"><a class="header" href="#dealing-with-key-triple-mappings-coherency">Dealing with key triple mappings coherency</a></h3>
<p>During the lifetime of the Parsec service, it might happen that the mappings do not correctly
reflect the state of the actual key store: a key stored in the KeyInfoManager does not map to any
key in the keystore backend. Providers should implement the following policies to prevent that.</p>
<ul>
<li>During the provider construction, fetch all key infos linked to that provider. For each one of
them, get the associated ID and issue one command to the backend to check if a key with that ID
exists. If it does not, add the key to a <code>to_delete</code> list and then delete all the mappings in the
<code>to_delete</code> list. Check the existing providers' constructors for an example.</li>
<li>Follow the algorithm described in the documentation of <code>psa_generate_key</code>, <code>psa_import_key</code> and
<code>psa_destroy_key</code> when implementing those <code>Provide</code> methods.</li>
</ul>
<p>The goal of those policies is to make sure, in a best-effort way, that key management operations
have the behaviour wanted: it is possible to create a key with the same name if the key
creation/deletion operation failed and that at any given time only valid keys can be used.</p>
<p>Because of those policies focused on clients' convenience, it might be possible that some keys
become &quot;zombies&quot; in the keystore: they can no longer be accessed via Parsec but still exist.</p>
<p>Please also note that those policies do not protect against hardware attacks. In our threat model is
documented as an assumption (ASUM-1):</p>
<blockquote>
<p>The hardware modules are physically and functionally secure. Only trusted agents can physically
access the system.</p>
</blockquote>
<p><em>Copyright 2019 Contributors to the Parsec project.</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../parsec_service/key_info_managers.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../parsec_service/build_run.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../parsec_service/key_info_managers.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../parsec_service/build_run.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
