<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>How to add operations to Parsec - The Parsec Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">2.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../getting_started/index.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting_started/linux_x86.html"><strong aria-hidden="true">3.1.</strong> Quickstart for Linux on x86</a></li><li class="chapter-item expanded "><a href="../getting_started/opensuse.html"><strong aria-hidden="true">3.2.</strong> Quickstart for openSUSE and SUSE</a></li><li class="chapter-item expanded "><a href="../getting_started/docker.html"><strong aria-hidden="true">3.3.</strong> Quickstart using a Docker container</a></li><li class="chapter-item expanded "><a href="../getting_started/installation_options.html"><strong aria-hidden="true">3.4.</strong> Installation Guide</a></li><li class="chapter-item expanded "><a href="../getting_started/parsec_tool_use.html"><strong aria-hidden="true">3.5.</strong> Parsec Tool Guide</a></li></ol></li><li class="chapter-item expanded "><a href="../parsec_users.html"><strong aria-hidden="true">4.</strong> Parsec for users</a></li><li class="chapter-item expanded "><a href="../parsec_client/index.html"><strong aria-hidden="true">5.</strong> Parsec for client developers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_client/api_overview.html"><strong aria-hidden="true">5.1.</strong> API Overview</a></li><li class="chapter-item expanded "><a href="../parsec_client/wire_protocol.html"><strong aria-hidden="true">5.2.</strong> Wire Protocol</a></li><li class="chapter-item expanded "><a href="../parsec_client/status_codes.html"><strong aria-hidden="true">5.3.</strong> Status Codes</a></li><li class="chapter-item expanded "><a href="../parsec_client/writing_library.html"><strong aria-hidden="true">5.4.</strong> Writing a new Parsec Client Library</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/index.html"><strong aria-hidden="true">5.5.</strong> Operations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_client/operations/service_api_coverage.html"><strong aria-hidden="true">5.5.1.</strong> Parsec Operations Coverage</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_key_attributes.html"><strong aria-hidden="true">5.5.2.</strong> PSA Key Attributes</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_algorithm.html"><strong aria-hidden="true">5.5.3.</strong> PSA Algorithm</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/ping.html"><strong aria-hidden="true">5.5.4.</strong> Ping</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_generate_key.html"><strong aria-hidden="true">5.5.5.</strong> PsaGenerateKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_destroy_key.html"><strong aria-hidden="true">5.5.6.</strong> PsaDestroyKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_sign_hash.html"><strong aria-hidden="true">5.5.7.</strong> PsaSignHash</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_verify_hash.html"><strong aria-hidden="true">5.5.8.</strong> PsaVerifyHash</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_import_key.html"><strong aria-hidden="true">5.5.9.</strong> PsaImportKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_export_public_key.html"><strong aria-hidden="true">5.5.10.</strong> PsaExportPublicKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_providers.html"><strong aria-hidden="true">5.5.11.</strong> ListProviders</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_opcodes.html"><strong aria-hidden="true">5.5.12.</strong> ListOpcodes</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_asymmetric_encrypt.html"><strong aria-hidden="true">5.5.13.</strong> PsaAsymmetricEncrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_asymmetric_decrypt.html"><strong aria-hidden="true">5.5.14.</strong> PsaAsymmetricDecrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_export_key.html"><strong aria-hidden="true">5.5.15.</strong> PsaExportKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_generate_random.html"><strong aria-hidden="true">5.5.16.</strong> PsaGenerateRandom</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_authenticators.html"><strong aria-hidden="true">5.5.17.</strong> ListAuthenticators</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_hash_compute.html"><strong aria-hidden="true">5.5.18.</strong> PsaHashCompute</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_hash_compare.html"><strong aria-hidden="true">5.5.19.</strong> PsaHashCompare</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_aead_encrypt.html"><strong aria-hidden="true">5.5.20.</strong> PsaAeadEncrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_aead_decrypt.html"><strong aria-hidden="true">5.5.21.</strong> PsaAeadDecrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_raw_key_agreement.html"><strong aria-hidden="true">5.5.22.</strong> PsaRawKeyAgreement</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_cipher_encrypt.html"><strong aria-hidden="true">5.5.23.</strong> PsaCipherEncrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_cipher_decrypt.html"><strong aria-hidden="true">5.5.24.</strong> PsaCipherDecrypt</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_mac_compute.html"><strong aria-hidden="true">5.5.25.</strong> PsaMacCompute</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_mac_verify.html"><strong aria-hidden="true">5.5.26.</strong> PsaMacVerify</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_sign_message.html"><strong aria-hidden="true">5.5.27.</strong> PsaSignMessage</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/psa_verify_message.html"><strong aria-hidden="true">5.5.28.</strong> PsaVerifyMessage</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_keys.html"><strong aria-hidden="true">5.5.29.</strong> ListKeys</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/list_clients.html"><strong aria-hidden="true">5.5.30.</strong> ListClients</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/delete_client.html"><strong aria-hidden="true">5.5.31.</strong> DeleteClient</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/prepare_key_attestation_params.html"><strong aria-hidden="true">5.5.32.</strong> Prepare Key Attestation Parameters</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/prepare_key_attestation.html"><strong aria-hidden="true">5.5.33.</strong> PrepareKeyAttestation</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/attest_key.html"><strong aria-hidden="true">5.5.34.</strong> AttestKey</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/attest_key_params.html"><strong aria-hidden="true">5.5.35.</strong> Attest Key Parameters</a></li><li class="chapter-item expanded "><a href="../parsec_client/operations/can_do_crypto.html"><strong aria-hidden="true">5.5.36.</strong> CanDoCrypto</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../parsec_service/index.html"><strong aria-hidden="true">6.</strong> Parsec for service developers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_service/interfaces_and_dataflow.html"><strong aria-hidden="true">6.1.</strong> Interfaces and Dataflow</a></li><li class="chapter-item expanded "><a href="../parsec_service/source_code_structure.html"><strong aria-hidden="true">6.2.</strong> Source Code Structure</a></li><li class="chapter-item expanded "><a href="../parsec_service/listeners.html"><strong aria-hidden="true">6.3.</strong> Listeners</a></li><li class="chapter-item expanded "><a href="../parsec_service/authenticators.html"><strong aria-hidden="true">6.4.</strong> Authenticators</a></li><li class="chapter-item expanded "><a href="../parsec_service/converters.html"><strong aria-hidden="true">6.5.</strong> Converters</a></li><li class="chapter-item expanded "><a href="../parsec_service/providers.html"><strong aria-hidden="true">6.6.</strong> Providers</a></li><li class="chapter-item expanded "><a href="../parsec_service/key_info_managers.html"><strong aria-hidden="true">6.7.</strong> Key Info Managers</a></li><li class="chapter-item expanded "><a href="../parsec_service/adding_provider.html"><strong aria-hidden="true">6.8.</strong> Adding a new Parsec Provider</a></li><li class="chapter-item expanded "><a href="../parsec_service/build_run.html"><strong aria-hidden="true">6.9.</strong> How to build and run Parsec</a></li><li class="chapter-item expanded "><a href="../parsec_service/install_parsec_linux.html"><strong aria-hidden="true">6.10.</strong> How to securely install Parsec on Linux</a></li><li class="chapter-item expanded "><a href="../parsec_service/configuration.html"><strong aria-hidden="true">6.11.</strong> Parsec Configuration</a></li><li class="chapter-item expanded "><a href="../parsec_service/tests/index.html"><strong aria-hidden="true">6.12.</strong> How to test Parsec</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_service/tests/existing_tests.html"><strong aria-hidden="true">6.12.1.</strong> List of existing tests</a></li></ol></li><li class="chapter-item expanded "><a href="../parsec_service/stability.html"><strong aria-hidden="true">6.13.</strong> Parsec Stability</a></li></ol></li><li class="chapter-item expanded "><a href="../parsec_security/index.html"><strong aria-hidden="true">7.</strong> Parsec Security</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../parsec_security/parsec_threat_model/threat_model.html"><strong aria-hidden="true">7.1.</strong> Parsec Threat Model</a></li><li class="chapter-item expanded "><a href="../parsec_security/secure_deployment.html"><strong aria-hidden="true">7.2.</strong> Recommendations for Secure Deployment</a></li><li class="chapter-item expanded "><a href="../parsec_security/rust_client_threat_model/threat_model.html"><strong aria-hidden="true">7.3.</strong> Parsec Rust Client Threat Model</a></li></ol></li><li class="chapter-item expanded "><a href="../contributing/index.html"><strong aria-hidden="true">8.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contributing/pr_checklist.html"><strong aria-hidden="true">8.1.</strong> Pull request checklist</a></li><li class="chapter-item expanded "><a href="../contributing/adding_new_operation_how_to.html" class="active"><strong aria-hidden="true">8.2.</strong> How to add operations to Parsec</a></li><li class="chapter-item expanded "><a href="../contributing/package_management.html"><strong aria-hidden="true">8.3.</strong> Package management and versioning guide</a></li><li class="chapter-item expanded "><a href="../contributing/release_process.html"><strong aria-hidden="true">8.4.</strong> The Parsec Release Process</a></li><li class="chapter-item expanded "><a href="../contributing/release_checklist.html"><strong aria-hidden="true">8.5.</strong> The Parsec Release Checklist</a></li></ol></li><li class="chapter-item expanded "><a href="../archive/index.html"><strong aria-hidden="true">9.</strong> Archive</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../archive/system_architecture.html"><strong aria-hidden="true">9.1.</strong> System Architecture</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Parsec Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="adding-operations-to-parsec"><a class="header" href="#adding-operations-to-parsec">Adding operations to Parsec</a></h1>
<p>This mini how-to will cover how to add operations to the Parsec service and Rust client. The steps
for adding a new provider operation will differ between providers, this guide will cover Mbed
Crypto. The steps for adding operations to <a href="#parsec">Parsec</a>, <a href="#parsec-interface-rs">Rust
interface</a>, and <a href="#parsec-client-rust">Rust client</a> should be the same for all
backend providers.</p>
<h2 id="operation-specification"><a class="header" href="#operation-specification">Operation specification</a></h2>
<h3 id="parsec-book"><a class="header" href="#parsec-book">parsec-book</a></h3>
<p>Create the specification page for the Parsec Book, under
<a href="https://parallaxsecond.github.io/parsec-book/parsec_client/operations/index.html">Operations</a> (can
also be found in the menu on the left of all pages). Include operation details such as parameters,
results, errors specific to the operation, a description, and a link to the
<a href="#parsec-operations">protobuf</a> contract (which will be created further on). Also update all API
tables on the <a href="../parsec_client/operations/service_api_coverage.html">Parsec Operations Coverage</a> page
to reflect the new addition (create any API tables if they are missing).</p>
<p>The opcode used should be the next available one. To find this, go to
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/master/src/requests/mod.rs"><code>parsec-interface-rs/src/requests/mod.rs</code></a>
and find the largest in-use opcode.</p>
<h3 id="parsec-operations"><a class="header" href="#parsec-operations">parsec-operations</a></h3>
<p>Create the <code>protobuf</code> contracts in
<a href="https://github.com/parallaxsecond/parsec-operations/tree/master/protobuf"><code>parsec-operations</code></a>.
These are the contracts that client libraries use to communicate with the Parsec service.</p>
<h2 id="rust-interface"><a class="header" href="#rust-interface">Rust Interface</a></h2>
<h3 id="parsec-interface-rs"><a class="header" href="#parsec-interface-rs">parsec-interface-rs</a></h3>
<p>Create the Rust interfaces for the operation. These interfaces go between
<a href="#parsec-operations"><code>protobuf</code></a> and the <a href="#parsec">Parsec service</a> on the service side, and the Rust
client library and protobuf on the client side. Take care when deciding on datatypes. Sensitive data
should be wrapped in either
<a href="https://docs.rs/zeroize/latest/zeroize/struct.Zeroizing.html"><code>Zeroizing</code></a> or
<a href="https://docs.rs/secrecy/latest/secrecy/struct.Secret.html"><code>Secret</code></a> (choose depending on the
sensitivity of the data. Favor
<a href="https://docs.rs/zeroize/latest/zeroize/struct.Zeroizing.html"><code>Zeroizing</code></a> unless there is a clear
requirement for <a href="https://docs.rs/secrecy/latest/secrecy/struct.Secret.html"><code>Secret</code></a>) to ensure
they are wiped from memory when dropped and should not have any output for debugging. The operation
definitions are stored in
<a href="https://github.com/parallaxsecond/parsec-interface-rs/tree/master/src/operations"><code>src/operations/</code></a>.</p>
<p>A <code>validate</code> method can be added to allow easy validation of the properties of the operations, to
check if there are any conflicting options, or combinations of options that are invalid. Tests must
be added for each operation with a validate method, to check it catches all erroneous combinations
of operation, and passes valid combinations.</p>
<p>A converter then needs to be added to
<a href="https://github.com/parallaxsecond/parsec-interface-rs/tree/master/src/operations_protobuf"><code>src/operations_protobuf</code></a>.
This will convert to and from the protobuf contract and the Rust interface. There should be four
methods per operation; two for going to and from the operation struct, and two for going to and from
the result struct. Again, tests need to be added to ensure all conversions happen correctly.</p>
<p>New protobuf operations need to be added to the <code>parsec-operations</code> submodule - do this by entering
the submodule, then fetching and checking out the new contracts. Protobuf-generated code needs to be
committed in the repository to speed up the builds and remove some of the dependencies. You
therefore need to run a build using the <code>regenerate-protobuf</code> feature enabled and then to identify
the generated Rust file in the correct directory, e.g.
<code>target/debug/build/parsec-interface-fdbf7d7248ab4615/out/</code>. The file must be copied to
<code>src/operations_protobuf/generated_ops/</code> and enabled as a module in <code>mod.rs</code>. If your Rust operation
and/or result interfaces do not contain any sensitive information, add them to the
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/f924c0f45695ebd88e34537934c579be8909cced/src/operations_protobuf/generated_ops.rs#L129"><code>empty_clear_message!</code></a>
block. Otherwise, implement
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/f924c0f45695ebd88e34537934c579be8909cced/src/operations_protobuf/generated_ops.rs#L116"><code>ClearProtoMessage</code></a>
for the interface/s that contain sensitive information and
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/f924c0f45695ebd88e34537934c579be8909cced/src/operations_protobuf/generated_ops.rs#L146"><code>zeroize</code></a>
any of the sensitive fields.</p>
<p>In
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/master/src/requests/mod.rs"><code>src/requests/mod.rs</code></a>,
add the opcode that was specified in the <a href="#parsec-book"><code>parsec-book</code></a> for the operation. Finally,
add the relevant
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/f924c0f45695ebd88e34537934c579be8909cced/src/operations/mod.rs#L32"><code>NativeOperation</code></a>
and
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/f924c0f45695ebd88e34537934c579be8909cced/src/operations/mod.rs#L79"><code>NativeResult</code></a>
entries, along with the mappings to the opcode from the
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/f924c0f45695ebd88e34537934c579be8909cced/src/operations/mod.rs#L59"><code>NativeOperation</code></a>
and
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/f924c0f45695ebd88e34537934c579be8909cced/src/operations/mod.rs#L106"><code>NativeResult</code></a>
to the Opcode. Then, add <code>From</code> implementations to <code>NativeOperation</code> and <code>NativeResult</code>.</p>
<p>Finally, add the <code>mod</code> declaration in
<a href="https://github.com/parallaxsecond/parsec-interface-rs/blob/master/src/operations_protobuf/mod.rs"><code>src/operations_protobuf/mod.rs</code></a>,
along with the entries in <code>body_to_operation</code>, <code>operation_to_body</code>, <code>body_to_result</code> and
<code>result_to_body</code>.</p>
<h2 id="parsec-rust-client"><a class="header" href="#parsec-rust-client">Parsec Rust client</a></h2>
<h3 id="parsec-client-rust"><a class="header" href="#parsec-client-rust">parsec-client-rust</a></h3>
<p>Add the user facing methods to
<a href="https://github.com/parallaxsecond/parsec-client-rust/blob/master/src/core/basic_client.rs"><code>src/core/basic_client.rs</code></a>.
These are what users interacting with Parsec using Rust will use as the entrypoint. They are also
what <a href="https://github.com/parallaxsecond/parsec/blob/master/e2e_tests/src/lib.rs">Parsec’s e2e test
suit</a> uses to test
Parsec, which is why this step comes before extending Parsec. Add the relevant tests to
<a href="https://github.com/parallaxsecond/parsec-client-rust/blob/master/src/core/testing/core_tests.rs"><code>src/core/testing/core_tests.rs</code></a>.</p>
<h3 id="other-clients-eg-go"><a class="header" href="#other-clients-eg-go">Other clients (e.g. Go)</a></h3>
<p>The procedure for adding operations to another client library should be similar. We encourage that
all clients should be updated to allow the new operation is as many languages as possible.</p>
<h2 id="parsec"><a class="header" href="#parsec">Parsec</a></h2>
<h3 id="psa-crypto-sys"><a class="header" href="#psa-crypto-sys">psa-crypto-sys</a></h3>
<p>Locate the parts of the <a href="https://armmbed.github.io/mbed-crypto/html/index.html">PSA API</a> in Mbed
Crypto that will need to be used during the operation you are adding. This includes all constants,
datatypes, macros and functions. Note: Mbed Crypto does not yet fully conform to the PSA API 1.0
specification, so there may be inconsistencies between the PSA documentation and the macros and
functions that Mbed Crypto exposes.</p>
<p>Starting in
<a href="https://github.com/parallaxsecond/rust-psa-crypto/tree/master/psa-crypto-sys"><code>psa-crypto-sys</code></a>,
constants are added to
<a href="https://github.com/parallaxsecond/rust-psa-crypto/blob/master/psa-crypto-sys/src/constants.rs"><code>constants.rs</code></a>.
Inline functions and macros require a shim. Add the inline function and macro definitions into
<a href="https://github.com/parallaxsecond/rust-psa-crypto/blob/master/psa-crypto-sys/src/c/shim.h"><code>shim.h</code></a>,
<a href="https://github.com/parallaxsecond/rust-psa-crypto/blob/master/psa-crypto-sys/src/c/shim.c"><code>shim.c</code></a>
and
<a href="https://github.com/parallaxsecond/rust-psa-crypto/blob/master/psa-crypto-sys/src/shim.rs"><code>shim.rs</code></a>.
When adding entries to
<a href="https://github.com/parallaxsecond/rust-psa-crypto/blob/master/psa-crypto-sys/src/shim.rs"><code>shim.rs</code></a>,
take note of where you place
<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#using-extern-functions-to-call-external-code"><code>unsafe</code></a>.
If the <a href="https://armmbed.github.io/mbed-crypto/html/index.html">PSA API</a> specification states that
under any circumstance, an unspecified result can be returned, then mark the entire <code>fn</code> definition
as <code>unsafe</code>. Otherwise, if the return values are always specified, wrap the call to the shim method
as <code>unsafe</code>. Regular functions are added to <a href="https://github.com/parallaxsecond/rust-psa-crypto/blob/master/psa-crypto-sys/src/lib.rs"><code>pub use psa_crypto_binding::{ … }</code></a>.</p>
<h3 id="psa-crypto"><a class="header" href="#psa-crypto">psa-crypto</a></h3>
<p>Define a Rust native interface for the operation you are adding in
<a href="https://github.com/parallaxsecond/rust-psa-crypto/tree/master/psa-crypto/src/operations"><code>src/operations</code></a>,
along with any Rust native types you need in
<a href="https://github.com/parallaxsecond/rust-psa-crypto/tree/master/psa-crypto/src/types"><code>src/types</code></a>.
Generally, any helper macro functions are placed in the <code>impl</code> block of the Rust native type they
are for.</p>
<p>The interface will work between the Rust native datatypes given to it and the C bindings in
<a href="#psa-crypto-sys"><code>psa-crypto-sys</code></a>. It is important to ensure that the Rust interface handles all
possible situations (e.g. closing a key-handle on an error) to ensure it is a safe Rust native
interface to the operation.</p>
<p>At this point, you will now have a safe Rust interface for the PSA operation you added.</p>
<h3 id="parsec-1"><a class="header" href="#parsec-1">parsec</a></h3>
<p>Add the new operation to the correct
<a href="https://github.com/parallaxsecond/parsec/tree/master/src/providers">provider</a> (in this case, <a href="https://github.com/parallaxsecond/parsec/tree/master/src/providers/mbed_crypto">Mbed
Crypto</a>) as a
<code>psa_xxx_internal</code> method. The operation method should take the user inputs, arrange them in a way
that <a href="#psa-crypto"><code>psa-crypto</code></a> accepts, and provide any extra logic or storage if required (e.g.
an output buffer). The external implementation is to be added to the provider’s
<a href="https://github.com/parallaxsecond/parsec/blob/master/src/providers/mbed_crypto/mod.rs"><code>mod.rs</code></a>
file, which outputs a trace entry and passes the call back to the internal implementation.</p>
<p>A default implementation is added to
<a href="https://github.com/parallaxsecond/parsec/blob/master/src/providers/mod.rs"><code>src/providers/mod.rs</code></a>
that is used when a provider does not support a particular operation. It outputs a trace entry and
returns an error, stating that the operation is not supported. The external implementation in the
provider’s <code>mod.rs</code> overrides this.</p>
<p>Add the <code>NativeOperation</code> mapping in
<a href="https://github.com/parallaxsecond/parsec/blob/master/src/back/backend_handler.rs"><code>src/back/backend_handler.rs</code></a>
<code>execute_request</code> function so Parsec can call the correct operation method when it receives a
request.</p>
<p>Finally, add <a href="https://github.com/parallaxsecond/parsec/tree/master/e2e_tests/tests/per_provider">end to end (e2e)
testing</a> for the
new operation. Operations are added to
<a href="https://github.com/parallaxsecond/parsec/blob/master/e2e_tests/src/lib.rs"><code>e2e_tests/src/lib.rs</code></a>
to save from code duplication in the tests. This also makes it quick and easy to write tests, and to
see exactly what operations a test is performing. Test should be very thorough, taking the operation
through valid and invalid inputs, checking that the proper output is returned. If possible, external
data and crates should be used during testing. E.g. if testing the cryptographic operation, generate
keys and an encrypted message externally and test that Parsec can correctly decrypt the message.
(Note: if crates are added solely for testing purposes, add them to <code>[dev-dependencies]</code> in
<a href="https://github.com/parallaxsecond/parsec/blob/master/e2e_tests/Cargo.toml"><code>Cargo.toml</code></a>)</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../contributing/pr_checklist.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../contributing/package_management.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../contributing/pr_checklist.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../contributing/package_management.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
